name: Build APK

on: [push]

jobs:
  build:
    runs-on: ubuntu-22.04  # Ubuntu 22.04 daha stabil
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install system dependencies
      run: |
        sudo dpkg --add-architecture i386
        sudo apt-get update -qq
        sudo apt-get install -qq -y \
          build-essential libffi-dev libssl-dev \
          libtool autoconf automake \
          zlib1g-dev zlib1g:i386 \
          libncurses5-dev libncurses5:i386 \
          libstdc++6:i386 \
          git unzip zip \
          python3-pip
    
    - name: Install buildozer and dependencies
      run: |
        pip install --upgrade pip setuptools wheel
        pip install buildozer cython
    
    - name: Pre-configure SDK licenses
      run: |
        mkdir -p ~/.buildozer/android/platform/android-sdk/licenses
        echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > ~/.buildozer/android/platform/android-sdk/licenses/android-sdk-license
        echo "d56f5187479451eabf01fb78af6dfcb131a6481e" >> ~/.buildozer/android/platform/android-sdk/licenses/android-sdk-license
        echo "84831b9409646a918e30573bab4c9c91346d8abd" > ~/.buildozer/android/platform/android-sdk/licenses/android-sdk-preview-license
    
    - name: Build APK
      run: |
        buildozer android debug 2>&1 | tee build.log
      env:
        BUILDOZER_WARN_ON_ROOT: 0
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-artifacts
        path: |
          build.log
          bin/*.apk
    
    - name: Check APK
      run: |
        if [ -f "bin/"*.apk ]; then
          echo "✅ APK BAŞARIYLA OLUŞTURULDU!"
          ls -lh bin/*.apk
        else
          echo "❌ APK bulunamadı"
          tail -50 build.log
          exit 1
        fi
